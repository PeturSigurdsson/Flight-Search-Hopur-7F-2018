/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package views;

import static com.sun.javafx.iio.ImageStorage.ImageType.RGBA;
import containers.Bookings;
import datastructures.Booking;
import datastructures.Flight;
import datastructures.Seat;
import datastructures.User;
import java.awt.Color;
import java.awt.GridLayout;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.text.DecimalFormat;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.Set;
import javax.swing.JPanel;
import views.components.SeatButton;

/**
 *
 * @author greta
 */
public class BookingsView extends javax.swing.JPanel {
    private final Main parent;          //Parent JFrame
    private final Flight flight;        //Flight to get info from
    private final SimpleDateFormat df;  //Date formatter
    private final SimpleDateFormat tf;  //Time formatter
    private final ArrayList<Seat> selectedSeats;

    /**
     * Creates new form FlightInfoView
     * @param Main main
     * @param Flight flight
     */
    public BookingsView(Main main, Flight flight) {
        initComponents();
        this.parent = main;
        this.flight = flight;
        this.flight.orderSeats();
        this.df = new SimpleDateFormat("dd. MMM yyyy");
        this.tf = new SimpleDateFormat("HH:mm:ss");
        this.selectedSeats = new ArrayList<Seat>();
        loadInfo();
    }
    
    public void loadInfo() {
       //Fararstaður - Áfangastaður
        String inf = this.flight.getOrigin().getName() + " til " + 
                this.flight.getDestination().getName();
        jOriginAndDestination.setText(inf);
        //Tímasetningar
        jFlightDate.setText(this.df.format(this.flight.getDate()));
        jFlightTime.setText(this.tf.format(this.flight.getDate()));
        int flightLength = this.flight.getTraveltime()*60 * 1000;
        Date arrivalTime = new Date(this.flight.getDate().getTime() + flightLength);
        jFlightArrivalTime.setText(this.tf.format(arrivalTime));
        renderSeats();
    }
    
    /**
     * Renders seats into the jSeatContainer panel
     */
    public void renderSeats() {
        ArrayList<Seat> seats = this.flight.getSeats();
        int rows = 5;
        int columns = seats.size() / 4;
        jSeatContainer.setLayout(new GridLayout(rows, columns));
        
        for(int i = 0; i < rows; i++) {
            if ( i == 2) {
                for(int j = 0; j < columns; j++) {
                    jSeatContainer.add(new JPanel());
                }
            } else if (i > 2) {
                for(int j = 0; j < columns; j++) {
                    SeatButton button = new SeatButton(seats.get((i - 1) + j*4));
                    attachClickedHandlerToSeat(button);
                    jSeatContainer.add(button);
                }
            }else {
                for(int j = 0; j < columns; j++) {
                    SeatButton button = new SeatButton(seats.get(i + j*4));
                    attachClickedHandlerToSeat(button);
                    jSeatContainer.add(button);
                }
            }
        }
    }
    
    private void attachClickedHandlerToSeat(SeatButton seat) {
        seat.addActionListener(new ActionListener() {
            @Override
            public void actionPerformed(ActionEvent e) {
                seat.setSelected();
                if (seat.isSelected()) selectedSeats.add(seat.getSeat());
                else selectedSeats.remove(seat.getSeat());
                calculatePrice();
            }
        });
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jBackToSearchView = new javax.swing.JButton();
        jFlightTime = new javax.swing.JLabel();
        jFlightDate = new javax.swing.JLabel();
        jFlightTimeLabel = new javax.swing.JLabel();
        jFlightDateLabel = new javax.swing.JLabel();
        jFlightArrivalTimeLabel = new javax.swing.JLabel();
        jFlightArrivalTime = new javax.swing.JLabel();
        jHeader = new javax.swing.JLabel();
        jOriginAndDestination = new javax.swing.JLabel();
        jBookSeats = new javax.swing.JButton();
        jSeatContainer = new javax.swing.JPanel();
        jName = new javax.swing.JTextField();
        jSSNLabel = new javax.swing.JLabel();
        jSSN = new javax.swing.JTextField();
        jNameLabel = new javax.swing.JLabel();
        jPrice = new javax.swing.JLabel();
        jPassword = new javax.swing.JPasswordField();
        passwordLabel = new javax.swing.JLabel();

        setBackground(new java.awt.Color(255, 255, 255));

        jBackToSearchView.setBackground(new java.awt.Color(204, 204, 255));
        jBackToSearchView.setFont(new java.awt.Font("Courier New", 1, 11)); // NOI18N
        jBackToSearchView.setText("<-");
        jBackToSearchView.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                goToFlightInfoView(evt);
            }
        });

        jFlightTime.setFont(new java.awt.Font("Courier New", 0, 14)); // NOI18N

        jFlightDate.setFont(new java.awt.Font("Courier New", 0, 14)); // NOI18N

        jFlightTimeLabel.setFont(new java.awt.Font("Courier New", 1, 14)); // NOI18N
        jFlightTimeLabel.setText("Áætlaður farartími:");

        jFlightDateLabel.setFont(new java.awt.Font("Courier New", 1, 14)); // NOI18N
        jFlightDateLabel.setText("Dags:");

        jFlightArrivalTimeLabel.setFont(new java.awt.Font("Courier New", 1, 14)); // NOI18N
        jFlightArrivalTimeLabel.setText("Áætlaður komutími:");

        jFlightArrivalTime.setFont(new java.awt.Font("Courier New", 0, 14)); // NOI18N

        jHeader.setFont(new java.awt.Font("Courier New", 1, 18)); // NOI18N
        jHeader.setText("Bóka sæti");

        jOriginAndDestination.setFont(new java.awt.Font("Courier New", 1, 18)); // NOI18N

        jBookSeats.setBackground(new java.awt.Color(204, 204, 255));
        jBookSeats.setFont(new java.awt.Font("Courier New", 1, 11)); // NOI18N
        jBookSeats.setText("Bóka");
        jBookSeats.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                bookSeats(evt);
            }
        });

        jSeatContainer.setBorder(javax.swing.BorderFactory.createEtchedBorder());
        jSeatContainer.setLayout(new java.awt.GridLayout(1, 0));

        jName.setFont(new java.awt.Font("Courier New", 0, 14)); // NOI18N
        jName.setToolTipText("AMK 2 stafir");

        jSSNLabel.setFont(new java.awt.Font("Courier New", 1, 14)); // NOI18N
        jSSNLabel.setText("Kennitala:");

        jSSN.setFont(new java.awt.Font("Courier New", 0, 14)); // NOI18N
        jSSN.setToolTipText("123456-7890");

        jNameLabel.setFont(new java.awt.Font("Courier New", 1, 14)); // NOI18N
        jNameLabel.setText("Nafn:");

        jPrice.setFont(new java.awt.Font("Courier New", 1, 14)); // NOI18N
        jPrice.setHorizontalAlignment(javax.swing.SwingConstants.RIGHT);
        jPrice.setText("0 kr.");

        jPassword.setFont(new java.awt.Font("Courier New", 0, 14)); // NOI18N

        passwordLabel.setFont(new java.awt.Font("Courier New", 1, 14)); // NOI18N
        passwordLabel.setText("Lykilorð:");

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(layout.createSequentialGroup()
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                            .addComponent(jNameLabel, javax.swing.GroupLayout.PREFERRED_SIZE, 40, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addComponent(jSSNLabel)
                            .addComponent(passwordLabel))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                                .addComponent(jPassword, javax.swing.GroupLayout.Alignment.TRAILING, javax.swing.GroupLayout.PREFERRED_SIZE, 249, javax.swing.GroupLayout.PREFERRED_SIZE)
                                .addComponent(jSSN, javax.swing.GroupLayout.PREFERRED_SIZE, 249, javax.swing.GroupLayout.PREFERRED_SIZE))
                            .addComponent(jName, javax.swing.GroupLayout.PREFERRED_SIZE, 249, javax.swing.GroupLayout.PREFERRED_SIZE))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(jPrice, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                            .addComponent(jBookSeats)))
                    .addGroup(layout.createSequentialGroup()
                        .addComponent(jFlightArrivalTimeLabel)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jOriginAndDestination, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                    .addGroup(layout.createSequentialGroup()
                        .addGap(0, 0, Short.MAX_VALUE)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(jFlightArrivalTime, javax.swing.GroupLayout.Alignment.TRAILING, javax.swing.GroupLayout.PREFERRED_SIZE, 277, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addComponent(jFlightTime, javax.swing.GroupLayout.Alignment.TRAILING, javax.swing.GroupLayout.PREFERRED_SIZE, 277, javax.swing.GroupLayout.PREFERRED_SIZE)))
                    .addGroup(layout.createSequentialGroup()
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(jSeatContainer, javax.swing.GroupLayout.PREFERRED_SIZE, 555, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addGroup(layout.createSequentialGroup()
                                .addComponent(jFlightTimeLabel)
                                .addGap(17, 17, 17)
                                .addComponent(jFlightDate, javax.swing.GroupLayout.PREFERRED_SIZE, 287, javax.swing.GroupLayout.PREFERRED_SIZE))
                            .addGroup(layout.createSequentialGroup()
                                .addComponent(jBackToSearchView)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                                .addComponent(jHeader, javax.swing.GroupLayout.PREFERRED_SIZE, 300, javax.swing.GroupLayout.PREFERRED_SIZE))
                            .addComponent(jFlightDateLabel, javax.swing.GroupLayout.PREFERRED_SIZE, 40, javax.swing.GroupLayout.PREFERRED_SIZE))
                        .addGap(0, 247, Short.MAX_VALUE)))
                .addContainerGap())
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jBackToSearchView, javax.swing.GroupLayout.PREFERRED_SIZE, 36, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jHeader, javax.swing.GroupLayout.PREFERRED_SIZE, 36, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(27, 27, 27)
                .addComponent(jFlightDateLabel, javax.swing.GroupLayout.PREFERRED_SIZE, 20, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jFlightDate, javax.swing.GroupLayout.PREFERRED_SIZE, 20, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jFlightTimeLabel, javax.swing.GroupLayout.PREFERRED_SIZE, 20, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(layout.createSequentialGroup()
                        .addComponent(jOriginAndDestination, javax.swing.GroupLayout.PREFERRED_SIZE, 36, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jFlightTime, javax.swing.GroupLayout.PREFERRED_SIZE, 20, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jFlightArrivalTime, javax.swing.GroupLayout.PREFERRED_SIZE, 20, javax.swing.GroupLayout.PREFERRED_SIZE))
                    .addGroup(layout.createSequentialGroup()
                        .addComponent(jFlightArrivalTimeLabel, javax.swing.GroupLayout.PREFERRED_SIZE, 20, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addGap(15, 15, 15)
                        .addComponent(jSeatContainer, javax.swing.GroupLayout.PREFERRED_SIZE, 232, javax.swing.GroupLayout.PREFERRED_SIZE)))
                .addGap(29, 29, 29)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(layout.createSequentialGroup()
                        .addGap(19, 19, 19)
                        .addComponent(jPrice, javax.swing.GroupLayout.PREFERRED_SIZE, 20, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jBookSeats)
                        .addContainerGap(26, Short.MAX_VALUE))
                    .addGroup(layout.createSequentialGroup()
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                            .addComponent(jName, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addComponent(jNameLabel, javax.swing.GroupLayout.PREFERRED_SIZE, 20, javax.swing.GroupLayout.PREFERRED_SIZE))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                            .addComponent(jPassword, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addComponent(passwordLabel))
                        .addGap(12, 12, 12)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                            .addComponent(jSSN, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addComponent(jSSNLabel, javax.swing.GroupLayout.PREFERRED_SIZE, 20, javax.swing.GroupLayout.PREFERRED_SIZE))
                        .addGap(0, 0, Short.MAX_VALUE))))
        );
    }// </editor-fold>//GEN-END:initComponents

    
    /**
     * Sets the view back to FlightInfoView
     * @param evt 
     */
    private void goToFlightInfoView(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_goToFlightInfoView
        parent.loadFlightInfoView(null);
    }//GEN-LAST:event_goToFlightInfoView

    
    
    private void bookSeats(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_bookSeats
        boolean nameValidated = validateName();
        boolean ssnValidated = validateSSN();
        boolean passwordValidated = validatePassword();
        
        if (!nameValidated || !ssnValidated || !passwordValidated) return;
        if (selectedSeats.size() < 1) return;
        
        User newUser = new User(jSSN.getText(), jName.getText(), new String(jPassword.getPassword()));
        Bookings bookings = new Bookings();
        for (Seat s : selectedSeats) {
            bookings.addBooking(new Booking(newUser.getSsn(), s));
        }
        
        if (bookings.bookSeats() == 0){
            for (Seat s : selectedSeats) {
                s.setBooked();
            }
        }
    
        
        parent.loadFlightInfoView(this.flight);
    }//GEN-LAST:event_bookSeats

    /**
     * Skoðar hvort nafn sé gilt.
     * @return 
     */
    private boolean validateName() {
        boolean validated = jName.getText().length() > 2;
        if(!validated) jName.setBackground(new Color(1, 0, 0, 0.2f));
        else jName.setBackground(new Color(255, 255, 255));
        return validated; 
    }
    
     /**
     * Skoðar hvort Password sé gilt.
     * @return 
     */
    private boolean validatePassword() {
        boolean validated = jPassword.getPassword().length > 5;
        if (!validated) jPassword.setBackground(new Color(1, 0, 0, 0.2f));
        else jPassword.setBackground(new Color(255, 255, 255));
        return validated;
    } 
    
    
    /**
     * Skoðar hvort SSN sé gilt.
     * @return 
     */
    private boolean validateSSN() {
        String regex = "[0-9]{6}-[0-9]{4}";
        boolean matches = jSSN.getText().matches(regex);
        if(!matches) jSSN.setBackground(new Color(1, 0, 0, 0.2f));
        else jSSN.setBackground(new Color(255, 255, 255));
        return matches;
    }
    
    /**
     * Calculates price of selected seats;
     */
    private void calculatePrice() {
        DecimalFormat cf = new DecimalFormat("###,###,###");
        int price = this.flight.getPrice() * this.selectedSeats.size();
        jPrice.setText(String.format("%s kr.", cf.format(price)));
    }
    
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton jBackToSearchView;
    private javax.swing.JButton jBookSeats;
    private javax.swing.JLabel jFlightArrivalTime;
    private javax.swing.JLabel jFlightArrivalTimeLabel;
    private javax.swing.JLabel jFlightDate;
    private javax.swing.JLabel jFlightDateLabel;
    private javax.swing.JLabel jFlightTime;
    private javax.swing.JLabel jFlightTimeLabel;
    private javax.swing.JLabel jHeader;
    private javax.swing.JTextField jName;
    private javax.swing.JLabel jNameLabel;
    private javax.swing.JLabel jOriginAndDestination;
    private javax.swing.JPasswordField jPassword;
    private javax.swing.JLabel jPrice;
    private javax.swing.JTextField jSSN;
    private javax.swing.JLabel jSSNLabel;
    private javax.swing.JPanel jSeatContainer;
    private javax.swing.JLabel passwordLabel;
    // End of variables declaration//GEN-END:variables
}
